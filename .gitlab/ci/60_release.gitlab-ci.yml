deployer:upload:
  stage: release
  extends:
    - .rules:after-merge
    - .rules:stable-release
  needs:
    - deployer:build
  script:
    - mage deployer:upload
  artifacts:
    paths:
      - artifacts_list.json

prerelease tag on main:
  stage: release
  extends:
    - .rules:after-merge
  needs: []
  script:
    - ./ci/prerelease-tag.sh

# This job is invoked when a new stable release tag is applied. This job then associates the new tag with a new release.
stable release:
  stage: release
  extends:
    - .rules:stable-release
  needs:
    - deployer:upload
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  variables:
    CHANGELOG: https://gitlab.com/gitlab-org/ci-cd/runner-tools/grit/blob/$CI_COMMIT_TAG/CHANGELOG.md
    CI_PROJECT_ID: 48756626
  environment:
    name: stable/gitlab
    url: https://gitlab.com/gitlab-org/ci-cd/runner-tools/grit/-/releases
  script:
    - echo "Releasing new version $CI_COMMIT_TAG"
    - apk add jq
    - releaseSh=/tmp/release.sh
    - echo -n "release-cli create " > ${releaseSh}
    - echo -n "--name '${CI_COMMIT_TAG}' " >> ${releaseSh}
    - echo -n "--tag-name '${CI_COMMIT_TAG}' " >> ${releaseSh}
    - echo -n "--description \"See [the changelog](${CHANGELOG}) :rocket:\n\nGitLab Runner Infrastructure Toolkit (GRIT) documentation can be found at https://gitlab.com/gitlab-org/ci-cd/runner-tools/grit/-/blob/main/README.md\" " >> ${releaseSh}
    - jq -j '.[] | "  --assets-link \"{\\\"name\\\":\\\"\(.file_name)\\\",\\\"url\\\":\\\"\(.web_url)\\\",\\\"direct_asset_path\\\":\\\"\(.file_name)\\\"}\" "' <artifacts_list.json >> ${releaseSh}
    - sh ${releaseSh}
