default:
  image: ${CI_IMAGE}
  tags:
    - gitlab-org

variables:
  GO_VERSION: "go1.22.5"
  DOCKER_VERSION: "24.0.9"

.no_cache:
  cache: {}

.no_dependencies:
  dependencies: []

.no_cache_and_dependencies:
  extends:
    - .no_cache
    - .no_dependencies

.go-cache:
  variables:
    # build cache on non-main branches
    GOCACHE: $CI_PROJECT_DIR/.gocache-$CI_COMMIT_REF_PROTECTED
    # go module cache is based on go.sum as a cache key
    GOMODCACHE: $CI_PROJECT_DIR/.gomodcache
  before_script:
    - mkdir -p "$GOCACHE"
  cache:
    - key: "${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}"
      paths:
        - $CI_PROJECT_DIR/.gocache-false/
    - key:
        files:
          - $CI_PROJECT_DIR/go.mod
          - $CI_PROJECT_DIR/go.sum
      paths:
        - $GOMODCACHE

.docker_in_docker:
  image: docker:${DOCKER_VERSION}-git
  services:
    - docker:${DOCKER_VERSION}-dind
  variables:
    DOCKER_HOST: tcp://docker:2376/
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  tags:
    - gitlab-org-docker
